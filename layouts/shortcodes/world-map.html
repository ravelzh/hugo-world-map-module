{{- $site := .Page.Site -}}
{{- $P := $site.Params.worldMap | default dict -}}
{{- $bgL := $P.backgroundLight | default "#f0f9ff" -}}
{{- $bgD := $P.backgroundDark | default "#1f2937" -}}
{{- $fL := $P.mapFillLight | default "#cbd5e1" -}}
{{- $fD := $P.mapFillDark | default "#374151" -}}
{{- $strL := .Get "mapStrokeLight" | default ($P.mapStrokeLight | default "black") -}}
{{- $strD := .Get "mapStrokeDark" | default ($P.mapStrokeDark | default "white") -}}
{{- $tr := .Get "transparent" | default ($P.transparent | default false) -}}
{{- $dropShadow := .Get "dropShadow" | default ($P.dropShadow | default false) -}}
{{- $width := .Get "width" | default ($P.width | default "calc(100vw - 4rem)") -}}
{{- $maxWidth := .Get "maxWidth" | default ($P.maxWidth | default "1024px") -}}
{{- $borderRadius := .Get "borderRadius" | default ($P.borderRadius | default "8px") -}}

{{- /* Prepare values for printf to ensure no formatter breaks the CSS */ -}}
{{- $bgValL := $bgL }}{{- if $tr }}{{ $bgValL = "transparent" }}{{ end
-}}
{{- $bgValD := $bgD }}{{- if $tr }}{{ $bgValD = "transparent" }}{{ end
-}}

{{- $borderVal := "1px solid var(--wm-map-fill)" -}}
{{- if $tr }}{{ $borderVal = "none" }}{{ end -}}

{{- $shadowVal := "none" -}}
{{- $pbVal := "0" -}}
{{- if $dropShadow }}{{ $shadowVal = "drop-shadow(0 4px 6px rgba(0,0,0,0.3))" }}{{
$pbVal = "20px" }}{{ end -}}

{{- $visitedData := dict -}}
{{- $countryMap := $site.Data.country_map -}}
{{- $checkTaxonomies := slice "destinationen" "destinations" -}}
{{- if .Get "taxonomies" -}}
{{- $checkTaxonomies = split (.Get "taxonomies") "," -}}
{{- else if $P.taxonomies -}}
{{- $checkTaxonomies = $P.taxonomies -}}
{{- end -}}

{{- range $taxName := $checkTaxonomies -}}
{{- with index $site.Taxonomies $taxName -}}
{{- range $term, $pages := . -}}
{{- $termPage := $site.GetPage (printf "/%s/%s" $taxName $term) -}}
{{- if $termPage -}}
{{- $countryName := $termPage.Title -}}
{{- $link := $termPage.RelPermalink -}}
{{- $isoCode := index $countryMap $countryName -}}
{{- if not $isoCode }}{{ $isoCode = index $countryMap $term }}{{ end -}}
{{- if $isoCode -}}
{{- if not (index $visitedData $isoCode) -}}
{{- $visitedData = merge $visitedData (dict $isoCode (dict "name" $countryName "link" $link)) -}}
{{- end -}}
{{- end -}}
{{- end -}}
{{- end -}}
{{- end -}}
{{- end -}}

<style>
    {
            {
            - printf ` .wm-wrapper {
                --wm-border: %s;
                --wm-shadow: %s;
                --wm-pb: %s;
                --wm-bg: %s;
                --wm-map-fill: %s;
                --wm-map-stroke: %s;
                --wm-btn-bg: rgba(255, 255, 255, 0.6);
                --wm-btn-border: rgba(203, 213, 225, 0.6);
                --wm-btn-text: #333;
            }

            html.dark .wm-wrapper,
            .dark .wm-wrapper {
                --wm-bg: %s;
                --wm-map-fill: %s;
                --wm-map-stroke: %s;
                --wm-btn-bg: rgba(31, 41, 55, 0.6);
                --wm-btn-border: rgba(75, 85, 99, 0.6);
                --wm-btn-text: #e5e7eb;
            }

            .wm-wrapper {
                width: %s;
                max-width: %s;
                border-radius: %s;
            }

            ` $borderVal $shadowVal $pbVal $bgValL $fL $strL $bgValD $fD $strD $width $maxWidth $borderRadius | safeCSS
        }
    }
</style>

{{- $css := resources.Get "hugo-world-map-module/css/styles.css" | minify | fingerprint -}}
<link rel="stylesheet" href="{{ $css.RelPermalink | safeURL }}" integrity="{{ $css.Data.Integrity }}">

<div class="wm-wrapper wm-loading" id="wm-root" data-visited-label="{{ i18n " world_map_visited" | default
    (i18n "visited" | default "(Visited)" ) }}">
    <div id="wm-data-visit" data-json="{{ $visitedData | jsonify }}" style="display:none"></div>
    <div id="wm-data-map" data-json="{{ $countryMap | jsonify }}" style="display:none"></div>
    <div id="wm-data-iso" data-json="{{ $site.Data.iso_map | default dict | jsonify }}" style="display:none"></div>

    <div class="wm-loader" id="wm-loader"></div>

    <div class="wm-viewport" id="wm-viewport">
        {{- $svg := resources.Get "images/world.svg" -}}
        {{- if $svg -}}
        {{- $svg.Content | safeHTML -}}
        {{- else -}}
        <p style="color:red">World Map SVG not found in assets/images/world.svg</p>
        {{- end -}}
    </div>

    <div class="wm-tooltip" id="wm-tooltip"></div>

    <div class="wm-controls">
        <button class="wm-btn" id="wm-btn-zoom-in" aria-label="Zoom In">+</button>
        <button class="wm-btn" id="wm-btn-zoom-out" aria-label="Zoom Out">-</button>
    </div>
</div>

{{- $js := resources.Get "hugo-world-map-module/js/world-map.js" | minify | fingerprint -}}
<script src="{{ $js.RelPermalink | safeURL }}" integrity="{{ $js.Data.Integrity }}" defer></script>